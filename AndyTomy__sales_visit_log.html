<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>電池業務拜訪紀錄</title>
    <!-- 引入 Tailwind CSS 確保響應式設計與美觀 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .form-label {
            @apply block text-sm font-semibold text-gray-700 mb-1;
        }
        .form-input {
            @apply w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all duration-200;
        }
    </style>
</head>
<body class="p-6 md:p-10">

    <div class="max-w-4xl mx-auto bg-white rounded-2xl shadow-xl overflow-hidden p-6 md:p-10">
        <h1 class="text-3xl md:text-4xl font-bold text-center text-indigo-600 mb-6">業務拜訪紀錄</h1>
        <p class="text-center text-gray-500 mb-8">請在此填寫拜訪客戶的詳細資訊。</p>

        <!-- 顯示用戶 ID，方便未來追蹤 -->
        <div class="mb-6 p-4 bg-gray-100 rounded-lg text-sm text-gray-600">
            您的用戶 ID：<span id="userIdDisplay" class="font-mono text-xs break-all"></span>
        </div>
        
        <!-- 儲存狀態訊息 -->
        <div id="statusMessage" class="hidden mb-4 p-3 rounded-lg text-center font-medium"></div>

        <form id="visitForm" class="space-y-6">

            <!-- 客戶名稱 -->
            <div>
                <label for="clientName" class="form-label">客戶名稱</label>
                <input type="text" id="clientName" name="clientName" class="form-input" required>
            </div>

            <!-- 拜訪人員及職稱 -->
            <div>
                <label for="visitorInfo" class="form-label">拜訪客戶人員及職稱</label>
                <input type="text" id="visitorInfo" name="visitorInfo" class="form-input" placeholder="例：王小明, 業務經理" required>
            </div>

            <!-- 客戶地址 -->
            <div>
                <label for="clientAddress" class="form-label">客戶地址</label>
                <input type="text" id="clientAddress" name="clientAddress" class="form-input">
            </div>

            <!-- 客戶聯絡電話 -->
            <div>
                <label for="clientPhone" class="form-label">客戶聯絡電話</label>
                <input type="tel" id="clientPhone" name="clientPhone" class="form-input">
            </div>

            <!-- 客戶網頁 -->
            <div>
                <label for="clientWebsite" class="form-label">客戶網頁</label>
                <input type="url" id="clientWebsite" name="clientWebsite" class="form-input" placeholder="例：http://www.example.com">
            </div>

            <!-- 客戶使用到電池的產品 -->
            <div>
                <label for="batteryProducts" class="form-label">客戶使用到電池的產品</label>
                <textarea id="batteryProducts" name="batteryProducts" rows="3" class="form-input resize-y" placeholder="請列出客戶產品中需要用到電池的項目"></textarea>
            </div>

            <!-- 客戶該案件進度 -->
            <div>
                <label for="caseProgress" class="form-label">客戶該案件進度</label>
                <select id="caseProgress" name="caseProgress" class="form-input">
                    <option value="初次拜訪" selected>初次拜訪</option>
                    <option value="後續追蹤">後續追蹤</option>
                    <option value="洽談中">洽談中</option>
                    <option value="成交">成交</option>
                    <option value="未成交">未成交</option>
                </select>
            </div>

            <!-- 對應到的使用電池 -->
            <div>
                <label for="correspondingBattery" class="form-label">對應到的使用電池</label>
                <input type="text" id="correspondingBattery" name="correspondingBattery" class="form-input" placeholder="例：鋰電池, CR2032鈕扣電池">
            </div>

            <!-- 該次拜訪詳細內容 -->
            <div>
                <label for="visitNotes" class="form-label">該次拜訪詳細內容</label>
                <textarea id="visitNotes" name="visitNotes" rows="6" class="form-input resize-y" placeholder="請詳細描述本次拜訪的內容、討論重點、客戶需求與後續行動計畫"></textarea>
            </div>

            <!-- 送出按鈕 -->
            <div class="pt-4">
                <button type="submit" class="w-full bg-indigo-600 text-white font-bold py-3 px-6 rounded-xl hover:bg-indigo-700 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 shadow-md hover:shadow-lg">
                    儲存紀錄
                </button>
            </div>

        </form>

        <!-- 過去的拜訪紀錄 -->
        <div class="mt-12 border-t pt-8 border-gray-200">
            <h2 class="text-2xl font-bold text-gray-700 mb-6 text-center">歷史拜訪紀錄</h2>
            <div id="recordsContainer" class="space-y-6">
                <!-- 紀錄將由 JavaScript 動態顯示 -->
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // 設定 Firebase
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth, userId;
        const statusMessage = document.getElementById('statusMessage');
        const userIdDisplay = document.getElementById('userIdDisplay');
        const form = document.getElementById('visitForm');
        const recordsContainer = document.getElementById('recordsContainer');

        // 初始化 Firebase
        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            console.log("Firebase initialized.");
        } catch (e) {
            console.error("Error initializing Firebase:", e);
        }

        // 處理使用者驗證
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                console.log("User authenticated:", userId);
                userIdDisplay.textContent = userId;
                setupRealtimeListener();
            } else {
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                        console.log("Signed in with custom token.");
                    } else {
                        await signInAnonymously(auth);
                        console.log("Signed in anonymously.");
                    }
                } catch (error) {
                    console.error("Error signing in:", error);
                }
            }
        });

        // 設定即時資料監聽器
        function setupRealtimeListener() {
            if (!db || !userId) {
                console.warn("Database or user ID not available. Cannot set up listener.");
                return;
            }
            const collectionPath = `/artifacts/${appId}/users/${userId}/sales_visit_logs`;
            const q = query(collection(db, collectionPath));

            onSnapshot(q, (snapshot) => {
                recordsContainer.innerHTML = '';
                if (snapshot.empty) {
                    recordsContainer.innerHTML = '<p class="text-center text-gray-500">尚無拜訪紀錄。</p>';
                } else {
                    snapshot.forEach((doc) => {
                        const data = doc.data();
                        const recordCard = document.createElement('div');
                        recordCard.className = 'bg-gray-50 p-6 rounded-lg shadow-md border border-gray-200';
                        recordCard.innerHTML = `
                            <h3 class="text-xl font-bold text-indigo-700 mb-2">${data.clientName}</h3>
                            <p class="text-sm text-gray-500 mb-4">日期：${data.timestamp?.toDate().toLocaleString() || 'N/A'}</p>
                            <div class="space-y-2 text-gray-700">
                                <p><span class="font-medium">拜訪人員：</span>${data.visitorInfo}</p>
                                <p><span class="font-medium">案件進度：</span><span class="inline-block px-2 py-1 text-xs font-semibold rounded-full bg-blue-100 text-blue-800">${data.caseProgress}</span></p>
                                <p><span class="font-medium">對應電池：</span>${data.correspondingBattery || '未填寫'}</p>
                                <p><span class="font-medium">詳細內容：</span><br>${data.visitNotes || '未填寫'}</p>
                            </div>
                        `;
                        recordsContainer.appendChild(recordCard);
                    });
                }
            }, (error) => {
                console.error("Error listening to Firestore:", error);
                showStatusMessage('讀取紀錄失敗，請檢查網路連線。', 'bg-red-100 text-red-700');
            });
        }

        // 處理表單提交
        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!db || !userId) {
                showStatusMessage('資料庫連線失敗，請稍後再試。', 'bg-red-100 text-red-700');
                return;
            }

            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());
            data.timestamp = serverTimestamp(); // 使用 Firebase 服務器時間戳

            try {
                const collectionPath = `/artifacts/${appId}/users/${userId}/sales_visit_logs`;
                await addDoc(collection(db, collectionPath), data);
                showStatusMessage('紀錄已成功儲存！', 'bg-green-100 text-green-700');